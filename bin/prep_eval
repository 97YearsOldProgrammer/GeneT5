#!/usr/bin/env python3

import argparse
import json
import random
import pathlib

import lib.dataset as ds


parser = argparse.ArgumentParser(description='Prepare eval data from raw genome + GFF')
parser.add_argument('species_dir', type=str, metavar='<dir>',
    help='species directory with fna.gz + gff.gz')
parser.add_argument('-o', '--output', type=str, required=True,
    metavar='<file>', help='output JSON file path')
parser.add_argument('-n', '--num_samples', type=int, default=50,
    metavar='<int>', help='number of eval samples [%(default)i]')
parser.add_argument('-w', '--window_size', type=int, default=20000,
    metavar='<int>', help='genomic window size [%(default)i]')
parser.add_argument('-s', '--seed', type=int, default=42,
    metavar='<int>', help='random seed [%(default)i]')

args = parser.parse_args()
random.seed(args.seed)

# Find genome files
fna_path, gff_path = ds.find_genome_files(args.species_dir)
print(f"FASTA: {fna_path}")
print(f"GFF:   {gff_path}")

# Parse FASTA
print(f"\nParsing FASTA...")
sequences = ds.parse_fasta(fna_path)
print(f"  {len(sequences)} sequences loaded")

# Parse GFF and build gene index
print(f"Parsing GFF...")
features   = ds.parse_gff(gff_path)
gene_index = ds.build_gene_index(features)
gene_index = ds.filter_canonical_transcripts(gene_index)
print(f"  {len(gene_index)} genes indexed")

# Filter to protein-coding genes
coding_genes = ds.extract_coding_genes(gene_index)
print(f"  {len(coding_genes)} protein-coding genes with exons")

# Build samples
print(f"\nBuilding eval samples (window={args.window_size})...")
all_samples = []
for gene_id, gene_data in coding_genes.items():
    sample = ds.build_eval_sample(gene_id, gene_data, sequences, args.window_size)
    if sample:
        all_samples.append(sample)

print(f"  {len(all_samples)} valid samples from {len(set(s['seqid'] for s in all_samples))} chromosomes")

# Select diverse subset
selected = ds.select_diverse_samples(all_samples, args.num_samples)
print(f"  Selected {len(selected)} samples")

# Write output
output_path = pathlib.Path(args.output)
output_path.parent.mkdir(parents=True, exist_ok=True)

with open(output_path, 'w') as f:
    json.dump(selected, f)

size_mb = output_path.stat().st_size / 1024 / 1024
print(f"\nSaved: {output_path} ({size_mb:.1f} MB)")

# Summary
total_exons = sum(s["num_exons"] for s in selected)
chrs        = set(s["seqid"] for s in selected)
print(f"  Samples: {len(selected)}")
print(f"  Total exons: {total_exons}")
print(f"  Chromosomes: {len(chrs)}")
